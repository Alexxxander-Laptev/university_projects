MAIN SEGMENT CODE
CSEG AT 0
    JMP start    
CSEG AT 001BH
    JMP IntHandl    
USING 0
; Основная программа
RSEG MAIN
start:                
    CALL SetTimer0    ; Вызов подпрограммы запуска таймера    
    MainProg:                    ;Выполнение основной программы во время задержки
    DEC A
    JMP MainProg
JMP start
; Подпрограмма запуска таймера
SetTimer0:
    ; Устанавливаем время по формуле.
    MOV R3,  #168
    MOV TH0, #07DH ; Компенсация длительности задержки
    MOV TL0, #0DBH ; Компенсация длительности задержки
    SETB IE.7    ; Разрешаем прерывания
    SETB ET0    ; Разрешаем прерывание от Timer 1
    SETB PT0    ; Ставим прерыванию от Timer 1 наивысший приоритет
    MOV TMOD, #00000001B    ; Timer 1: режим 1 (16-битный таймер)
    SETB TR0    ; Запускаем таймер
RET
; Обработка прерывания от таймера 1
IntHandl:    
    DJNZ R3, RstTimer0    ; Уменьшаем счетчик, пока он не станет нулем    
    ; Если счетчик стал нудем, то отключаем таймер
    CLR TR0        ; Останавливаем таймер
    CLR IE.7       ; Запрещаем прерывания
    CLR ET0        ; Запрещаем прерывание от Timer 01
    CLR PT0        ; Убираем наивысший приоритет прерывания от Timer 1    
    ; Выполняем действие по окончанию задержки    
    RstTimer0:
RETI
END   








